<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLKH Real-time Dashboard</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .metric-value {
            font-weight: bold;
            color: #667eea;
        }
        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .alert.warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .alert.danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .alert.info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .controls button:hover {
            background: #5a6fd8;
        }
        .controls select, .controls input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
        }
        .status.connected {
            background: #28a745;
        }
        .status.disconnected {
            background: #dc3545;
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #00ff00;
        }
        .log-entry.error {
            color: #ff6b6b;
            border-left-color: #ff6b6b;
        }
        .log-entry.warning {
            color: #ffd93d;
            border-left-color: #ffd93d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä QLKH Real-time Dashboard</h1>
            <p>B√°o c√°o t·ªìn kho th·ªùi gian th·ª±c</p>
        </div>

        <div class="status" id="connectionStatus">Disconnected</div>

        <div class="controls">
            <h3>üéõÔ∏è ƒêi·ªÅu khi·ªÉn</h3>
            <select id="khuVucSelect">
                <option value="">T·∫•t c·∫£ khu v·ª±c</option>
                <option value="1">Khu v·ª±c 1</option>
                <option value="2">Khu v·ª±c 2</option>
                <option value="3">Khu v·ª±c 3</option>
                <option value="4">Khu v·ª±c 4</option>
            </select>
            
            <select id="khoSelect">
                <option value="">T·∫•t c·∫£ kho</option>
            </select>
            
            <button onclick="joinRoom()">üîó K·∫øt n·ªëi</button>
            <button onclick="getInventoryReport()">üìä L·∫•y b√°o c√°o</button>
            <button onclick="subscribeRealtime()">‚ö° Theo d√µi real-time</button>
            <button onclick="clearLog()">üóëÔ∏è X√≥a log</button>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3>üìà T·ªïng quan</h3>
                <div id="summaryMetrics">
                    <div class="metric">
                        <span>T·ªïng s·∫£n ph·∫©m:</span>
                        <span class="metric-value" id="totalProducts">-</span>
                    </div>
                    <div class="metric">
                        <span>T·ªïng s·ªë l∆∞·ª£ng:</span>
                        <span class="metric-value" id="totalQuantity">-</span>
                    </div>
                    <div class="metric">
                        <span>T·ªìn kho th·∫•p:</span>
                        <span class="metric-value" id="lowStock">-</span>
                    </div>
                    <div class="metric">
                        <span>H·∫øt h√†ng:</span>
                        <span class="metric-value" id="outOfStock">-</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üìÖ Giao d·ªãch h√¥m nay</h3>
                <div id="todayTransactions">
                    <div class="metric">
                        <span>Nh·∫≠p kho:</span>
                        <span class="metric-value" id="todayNhap">-</span>
                    </div>
                    <div class="metric">
                        <span>Xu·∫•t kho:</span>
                        <span class="metric-value" id="todayXuat">-</span>
                    </div>
                    <div class="metric">
                        <span>Thay ƒë·ªïi r√≤ng:</span>
                        <span class="metric-value" id="netChange">-</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>‚ö†Ô∏è C·∫£nh b√°o</h3>
                <div id="alerts">
                    <p>Ch∆∞a c√≥ c·∫£nh b√°o</p>
                </div>
            </div>

            <div class="card">
                <h3>üìä Chi ti·∫øt t·ªìn kho</h3>
                <div id="inventoryDetails">
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>üìù Log Real-time</h3>
            <div class="log" id="logContainer">
                <div class="log-entry">K·∫øt n·ªëi Socket.IO...</div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io('http://localhost:3000');
        let currentRoom = null;

        // Connection status
        socket.on('connect', () => {
            updateConnectionStatus(true);
            addLog('‚úÖ K·∫øt n·ªëi th√†nh c√¥ng', 'success');
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
            addLog('‚ùå M·∫•t k·∫øt n·ªëi', 'error');
        });

        // Room events
        socket.on('joined-room', (data) => {
            addLog(`üè† ƒê√£ tham gia room: Khu v·ª±c ${data.maKhuVuc || 'T·∫•t c·∫£'}, Kho ${data.maKho || 'T·∫•t c·∫£'}`, 'success');
            currentRoom = data;
        });

        socket.on('subscribed', (data) => {
            addLog(`‚ö° ƒê√£ ƒëƒÉng k√Ω real-time updates`, 'success');
        });

        // Report events
        socket.on('inventory-report', (data) => {
            if (data.success) {
                addLog(`üìä Nh·∫≠n b√°o c√°o t·ªìn kho: ${data.reportType}`, 'success');
                updateDashboard(data.data);
            } else {
                addLog(`‚ùå L·ªói b√°o c√°o: ${data.error}`, 'error');
            }
        });

        // Real-time updates
        socket.on('inventory-update', (data) => {
            addLog(`üîÑ C·∫≠p nh·∫≠t t·ªìn kho: ${data.changeType}`, 'warning');
            // Refresh dashboard
            getInventoryReport();
        });

        socket.on('transaction-update', (data) => {
            addLog(`üíº Giao d·ªãch m·ªõi: ${data.transactionType}`, 'info');
            // Refresh dashboard
            getInventoryReport();
        });

        socket.on('alert', (data) => {
            addLog(`‚ö†Ô∏è C·∫£nh b√°o: ${data.message}`, 'warning');
            showAlert(data);
        });

        socket.on('dashboard-update', (data) => {
            addLog(`üìä C·∫≠p nh·∫≠t dashboard`, 'info');
            updateDashboard(data);
        });

        // Functions
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            status.textContent = connected ? 'Connected' : 'Disconnected';
            status.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function joinRoom() {
            const maKhuVuc = document.getElementById('khuVucSelect').value;
            const maKho = document.getElementById('khoSelect').value;
            
            socket.emit('join-room', {
                maKhuVuc: maKhuVuc || null,
                maKho: maKho || null
            });
        }

        function getInventoryReport() {
            const maKhuVuc = document.getElementById('khuVucSelect').value;
            const maKho = document.getElementById('khoSelect').value;
            
            socket.emit('get-inventory-report', {
                maKhuVuc: maKhuVuc || null,
                maKho: maKho || null,
                reportType: 'summary'
            });
        }

        function subscribeRealtime() {
            const maKhuVuc = document.getElementById('khuVucSelect').value;
            const maKho = document.getElementById('khoSelect').value;
            
            socket.emit('subscribe-realtime', {
                maKhuVuc: maKhuVuc || null,
                maKho: maKho || null,
                updateTypes: ['inventory', 'transactions', 'alerts']
            });
        }

        function updateDashboard(data) {
            if (data.inventory) {
                document.getElementById('totalProducts').textContent = data.inventory.totalProducts || 0;
                document.getElementById('totalQuantity').textContent = data.inventory.totalQuantity || 0;
                document.getElementById('lowStock').textContent = data.inventory.lowStockItems || 0;
                document.getElementById('outOfStock').textContent = data.inventory.outOfStockItems || 0;
            }

            if (data.todayTransactions) {
                document.getElementById('todayNhap').textContent = data.todayTransactions.nhap?.quantity || 0;
                document.getElementById('todayXuat').textContent = data.todayTransactions.xuat?.quantity || 0;
                document.getElementById('netChange').textContent = data.todayTransactions.netChange || 0;
            }
        }

        function showAlert(alertData) {
            const alertsContainer = document.getElementById('alerts');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertData.alertType === 'out-of-stock' ? 'danger' : 
                                   alertData.alertType === 'low-stock' ? 'warning' : 'info'}`;
            alertDiv.textContent = alertData.message;
            alertsContainer.appendChild(alertDiv);
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (currentRoom) {
                getInventoryReport();
            }
        }, 30000);
    </script>
</body>
</html>
